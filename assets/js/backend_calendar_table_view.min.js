window.BackendCalendarTableView=window.BackendCalendarTableView||{},function(e){"use strict";var t,a,n;function r(e,t){$("#calendar .calendar-header .btn").addClass("disabled").prop("disabled",!0);var a={};$(".provider-column").each(function(e,t){var n=$(t);a[n.data("provider").id]=n.find(".calendar-wrapper").fullCalendar("getView").name}),$("#calendar .calendar-view").remove(),Backend.placeFooterToBottom();var n=$("<div/>",{class:"calendar-view"}).appendTo("#calendar");n.data({startDate:e.toString("yyyy-MM-dd"),endDate:t.toString("yyyy-MM-dd")});var r=$("<div/>").appendTo(n);b(e,t).done(function(n){for(var s=e;s<=t;)i(r,s,n),s.add({days:1});y(),Backend.placeFooterToBottom(),$("#calendar .calendar-header .btn").removeClass("disabled").prop("disabled",!1),$(".provider-column").each(function(e,t){var n=$(t),r=n.data("provider").id;n.find(".calendar-wrapper").fullCalendar("changeView",a[r]||"agendaDay")})})}function i(e,n,r){var i=$("<div/>",{class:"date-column"}).appendTo(e);i.data("date",n.getTime()),$("<h5/>",{class:"date-column-title",text:GeneralFunctions.formatDate(n,GlobalVariables.dateFormat)}).appendTo(i);var p=t.val(),m=a.val(),y=GlobalVariables.availableProviders.filter(function(e){var t=e.services.filter(function(e){return m.filter(function(t){return Number(e)===Number(t)}).length});return!p.length&&!m.length||p.length&&!m.length&&-1!==p.indexOf(e.id)||!p.length&&m.length&&t.length||p.length&&m.length&&t.length&&-1!==p.indexOf(e.id)});"provider"===GlobalVariables.user.role_slug&&GlobalVariables.availableProviders.forEach(function(e){Number(e.id)===Number(GlobalVariables.user.id)&&(y=[e])}),"secretary"===GlobalVariables.user.role_slug&&(y=[],GlobalVariables.availableProviders.forEach(function(e){GlobalVariables.secretaryProviders.indexOf(e.id)>-1&&y.push(e)})),y.forEach(function(e){(function e(t,a,n,r){if(0!==n.services.length){var i=$("<div/>",{class:"provider-column"}).appendTo(t);i.data("provider",n),function e(t,a,n){var r=$("<div/>",{class:"calendar-wrapper"}).appendTo(t),i="";switch(GlobalVariables.dateFormat){case"DMY":i="ddd D/M";break;case"MDY":case"YMD":i="ddd M/D";break;default:throw Error("Invalid date format setting provided!",GlobalVariables.dateFormat)}var o="",l="";switch(GlobalVariables.timeFormat){case"military":o="H:mm",l="H(:mm)";break;case"regular":o="h:mm a",l="h(:mm) a";break;default:throw Error("Invalid time format setting provided!"+GlobalVariables.timeFormat)}var c=GlobalVariables.firstWeekday,p=GeneralFunctions.getWeekDayId(c);r.fullCalendar({defaultView:"agendaDay",height:s(),editable:!0,timeFormat:o,slotLabelFormat:l,allDaySlot:!0,columnFormat:i,firstDay:p,snapDuration:"00:15:00",header:{left:"listDay,agendaDay",center:"",right:""},selectable:!0,selectHelper:!0,select:function(e,t,a){if(e.hasTime()&&t.hasTime()){$("#insert-appointment").trigger("click");var n=$(a.target).parents(".provider-column").data("provider").id,r=GlobalVariables.availableProviders.find(function(e){return Number(e.id)===Number(n)}),i=GlobalVariables.availableServices.find(function(e){return -1!==r.services.indexOf(e.id)});return i&&$("#select-service").val(i.id),$("#select-service").val()||$("#select-service option:first").prop("selected",!0),$("#select-service").trigger("change"),r&&$("#select-provider").val(r.id),$("#select-provider").val()||$("#select-provider option:first").prop("selected",!0),$("#select-provider").trigger("change"),$("#start-datetime").datepicker("setDate",new Date(e.format("YYYY/MM/DD HH:mm:ss"))),$("#end-datetime").datepicker("setDate",new Date(t.format("YYYY/MM/DD HH:mm:ss"))),!1}},monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],monthNamesShort:[EALang.january.substr(0,3),EALang.february.substr(0,3),EALang.march.substr(0,3),EALang.april.substr(0,3),EALang.may.substr(0,3),EALang.june.substr(0,3),EALang.july.substr(0,3),EALang.august.substr(0,3),EALang.september.substr(0,3),EALang.october.substr(0,3),EALang.november.substr(0,3),EALang.december.substr(0,3)],dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],buttonText:{today:EALang.today,day:EALang.day,week:EALang.week,month:EALang.month,agendaDay:EALang.calendar,listDay:EALang.list},eventClick:u,eventResize:f,eventDrop:v,viewRender:d}),r.fullCalendar("gotoDate",moment(a)),$("<h6/>",{text:n.first_name+" "+n.last_name}).prependTo(t)}(i,a,n),o(i.find(".calendar-wrapper"),n),l(i,r.appointments),c(i,r.unavailability_events),Backend.placeFooterToBottom()}})(i,n,e,r)})}function s(){var e=window.innerHeight-$("#footer").outerHeight()-$("#header").outerHeight()-60;return e>500?e:500}function d(e,t){$(t).fullCalendar("option","height",s())}function o(e,t){var a,n,r=JSON.parse(t.settings.working_plan),i=JSON.parse(t.settings.working_plan_exceptions)||{},s=e.fullCalendar("getView"),d=s.start.clone(),o=s.end.clone(),l=d.toDate().toString("dddd").toLowerCase(),c=d.format("YYYY-MM-DD"),p=[];if(i[c]){r[l]=i[c];var m=c+" "+r[l].start,u=c+" "+r[l].end,f={title:EALang.working_plan_exception,start:moment(m,"YYYY-MM-DD HH:mm",!0),end:moment(u,"YYYY-MM-DD HH:mm",!0).add(1,"day"),allDay:!0,color:"#879DB4",editable:!1,className:"fc-working-plan-exception fc-custom",data:{date:c,workingPlanException:i[c],provider:t}};p.push(f)}if(null===r[l]){var v={title:EALang.not_working,start:d,end:o,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"};p.push(v),e.fullCalendar("addEventSource",p);return}var y=moment(d.toDate().toString("yyyy-MM-dd")+" "+r[l].start);d<y&&(g={title:EALang.not_working,start:d,end:y,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"},p.push(g));var b=moment(d.toDate().toString("yyyy-MM-dd")+" "+r[l].end);if(o>b){var g={title:EALang.not_working,start:b,end:o,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable"};p.push(g)}r[l].breaks.forEach(function(e){a=moment(d.toDate().toString("yyyy-MM-dd")+" "+e.start),n=moment(d.toDate().toString("yyyy-MM-dd")+" "+e.end);var t={title:EALang.break,start:a,end:n,allDay:!1,color:"#BEBEBE",editable:!1,className:"fc-unavailable fc-break"};p.push(t)}),e.fullCalendar("addEventSource",p)}function l(e,t){if(0!==t.length){var n=a.val();t=t.filter(function(e){return!n.length||-1!==n.indexOf(e.id_services)});var r=[];for(var i in t){var s=t[i];s.id_users_provider===e.data("provider").id&&r.push({id:s.id,title:s.service.name+" - "+s.customer.first_name+" "+s.customer.last_name,start:moment(s.start_datetime),end:moment(s.end_datetime),allDay:!1,data:s})}e.find(".calendar-wrapper").fullCalendar("addEventSource",r)}}function c(e,t){if(0!==t.length){var a=[];for(var n in t){var r=t[n];if(r.id_users_provider===e.data("provider").id){var i={title:EALang.unavailable,start:moment(r.start_datetime),end:moment(r.end_datetime),allDay:!1,color:"#879DB4",editable:!0,className:"fc-unavailable fc-custom",data:r};a.push(i)}}e.find(".calendar-wrapper").fullCalendar("addEventSource",a)}}function p(e,t){if(0!==t.length){var a=new Date(e.parents(".date-column").data("date")),n=e.find("table tbody");for(var r in t){var i=t[r],s=i.start.split(":"),d=new Date(a.getFullYear(),a.getMonth(),a.getDate(),s[0],s[1]),o=i.end.split(":"),l=Math.round((new Date(a.getFullYear(),a.getMonth(),a.getDate(),o[0],o[1])-d)/6e4),c=$("<div/>",{class:"event unavailability break"});c.html(EALang.break+' <span class="hour">'+d.toString("HH:mm")+"</span> ("+l+"')"),c.data(i),n.find("tr").each(function(e,t){var n=$(t).find("td:first"),r=new Date(a.getTime()).set({hour:parseInt(n.text().split(":")[0]),minute:parseInt(n.text().split(":")[1])});if(d<r)return d.toString("HH:mm")===$(t).prev().find("td").eq(0).text()&&c.find(".hour").remove(),$(t).prev().find("td:gt(0)").each(function(e,t){c.clone().appendTo($(t))}),!1})}}}function m(e){if(!e.data||!e.data.notes)return"-";var t=e.data.notes;return t.length>100?t.substring(0,100)+"...":t}function u(e,t){$(".popover").popover("dispose");var a,r,i,s=$(t.target.offsetParent),d=$(t.target).parents().eq(1);$(this).hasClass("fc-unavailable")||s.hasClass("fc-unavailable")||d.hasClass("fc-unavailable")?(r=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",a=$("<div/>",{html:[$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.start.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.end.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.notes}),$("<span/>",{text:m(e)}),$("<br/>"),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2 "+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]}),]})]})):$(this).hasClass("fc-working-plan-exception")||s.hasClass("fc-working-plan-exception")||d.hasClass("fc-working-plan-exception")?(r=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=(s.hasClass("fc-custom")||d.hasClass("fc-custom"))&&!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",a=$("<div/>",{html:[$("<strong/>",{text:EALang.provider}),$("<span/>",{text:e.data?e.data.provider.first_name+" "+e.data.provider.last_name:"-"}),$("<br/>"),$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.data.date+" "+e.data.workingPlanException.start,GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.data.date+" "+e.data.workingPlanException.end,GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.timezone}),$("<span/>",{text:GlobalVariables.timezones[e.data.provider.timezone]}),$("<br/>"),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2 "+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]})]})]})):(r=!0===GlobalVariables.user.privileges.appointments.edit?"":"d-none",i=!0===GlobalVariables.user.privileges.appointments.delete?"":"d-none",a=$("<div/>",{html:[$("<strong/>",{text:EALang.start}),$("<span/>",{text:GeneralFunctions.formatDate(e.start.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.end}),$("<span/>",{text:GeneralFunctions.formatDate(e.end.format("YYYY-MM-DD HH:mm:ss"),GlobalVariables.dateFormat,!0)}),$("<br/>"),$("<strong/>",{text:EALang.timezone}),$("<span/>",{text:GlobalVariables.timezones[e.data.provider.timezone]}),$("<br/>"),$("<strong/>",{text:EALang.service}),$("<span/>",{text:e.data.service.name}),$("<br/>"),$("<strong/>",{text:EALang.provider}),GeneralFunctions.renderMapIcon(e.data.provider),$("<span/>",{text:e.data.provider.first_name+" "+e.data.provider.last_name}),$("<br/>"),$("<strong/>",{text:EALang.customer}),GeneralFunctions.renderMapIcon(e.data.customer),$("<span/>",{text:e.data.customer.first_name+" "+e.data.customer.last_name}),$("<br/>"),$("<strong/>",{text:EALang.email}),GeneralFunctions.renderMailIcon(e.data.customer.email),$("<span/>",{text:e.data.customer.email}),$("<br/>"),$("<strong/>",{text:EALang.phone}),GeneralFunctions.renderPhoneIcon(e.data.customer.phone_number),$("<span/>",{text:e.data.customer.phone_number}),$("<br/>"),$("<strong/>",{text:EALang.notes}),$("<span/>",{text:m(e)}),$("<hr/>"),$("<div/>",{class:"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label p-0",text:"Sex"}),$("<div/>",{class:"col p-0",text:e.data.customer.sex})]}),$("<div/>",{class:"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label p-0",text:"Birth Date"}),$("<div/>",{class:"col p-0",text:e.data.customer.birth_date})]}),$("<div/>",{class:"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label p-0",text:"Passport Number"}),$("<div/>",{class:"col p-0",text:e.data.customer.passport_number})]}),$("<div/>",{class:"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label p-0",text:"Passport Expiry Date"}),$("<div/>",{class:"col p-0",text:e.data.customer.passport_expiry_date})]}),$("<div/>",{class:"Not Applicable"==e.data.customer.applicant_type||null==e.data.customer.applicant_type?"d-none":"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label p-0",text:"Applicant Type"}),$("<div/>",{class:"col p-0",text:e.data.customer.applicant_type})]}),$("<div/>",{class:"Not Applicable"==e.data.customer.applicant_type||null==e.data.customer.applicant_type?"d-none":"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label  p-0",text:{CANADA:"IME/UCCI #",AUSTRALIA:"HAP ID","NEW ZEALAND":"NZER/NZHR"}[e.data.customer.applicant_type]}),$("<div/>",{class:"col p-0",text:e.data.customer.client_id_reference_number})]}),$("<div/>",{class:"Not Applicable"==e.data.customer.applicant_type||null==e.data.customer.applicant_type?"d-none":"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label  p-0",text:"Visa Type"}),$("<div/>",{class:"col p-0",text:e.data.customer.visa_type})]}),$("<div/>",{class:"Not Applicable"==e.data.customer.applicant_type||null==e.data.customer.applicant_type?"d-none":"form-group row pl-3 mb-0",html:[$("<b/>",{class:"col-sm-6 col-form-label  p-0",text:"Visa Category"}),$("<div/>",{class:"col p-0",text:e.data.customer.visa_category})]}),$("<button/>",{class:null==e.data.proof_of_payment?"d-none":"btn btn-sm btn-info mb-2",text:"View proof of payment",type:"button","data-toggle":"view-image-modal","data-href":GlobalVariables.baseUrl+"/storage/uploads/"+e.data.proof_of_payment,target:"_blank"}),$("<br/>"),$("<button/>",{class:null==e.data.proof_of_identity?"d-none":"btn btn-sm btn-info",text:"View proof of identity",type:"button","data-toggle":"view-image-modal","data-href":GlobalVariables.baseUrl+"/storage/uploads/"+e.data.proof_of_identity,target:"_blank"}),$("<hr/>"),$("<div/>",{class:"d-flex justify-content-center",html:[$("<button/>",{class:"close-popover btn btn-outline-secondary mr-2",html:[$("<i/>",{class:"fas fa-ban mr-2"}),$("<span/>",{text:EALang.close})]}),$("<button/>",{class:"delete-popover btn btn-outline-secondary mr-2 "+i,html:[$("<i/>",{class:"fas fa-trash-alt mr-2"}),$("<span/>",{text:EALang.delete})]}),$("<button/>",{class:"edit-popover btn btn-primary "+r,html:[$("<i/>",{class:"fas fa-edit mr-2"}),$("<span/>",{text:EALang.edit})]})]})]})),$(t.target).popover({placement:"top",title:e.title,content:a,html:!0,container:"#calendar",trigger:"manual"}),n=e,$(t.target).popover("toggle"),$(".popover").length>0&&$(".popover").position().top<200&&$(".popover").css("top","200px")}function f(e,t,a){if(!1===GlobalVariables.user.privileges.appointments.edit){a(),Backend.displayNotification(EALang.no_privileges_edit_appointments);return}var n,r=$("#calendar");if($("#notification").is(":visible")&&$("#notification").hide("bind"),"0"===e.data.is_unavailable){e.data.end_datetime=Date.parseExact(e.data.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:t.days(),hours:t.hours(),minutes:t.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var i=GeneralFunctions.clone(e.data);delete i.customer,delete i.provider,delete i.service,n=function(){var n=function(){i.end_datetime=e.data.end_datetime=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-t.days(),hours:-t.hours(),minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_appointment",r={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(i)};$.post(n,r).done(function(){$("#notification").hide("blind")}),a()};Backend.displayNotification(EALang.appointment_updated,[{label:EALang.undo,function:n}]),$("#footer").css("position","static"),r.fullCalendar("updateEvent",e)},BackendCalendarApi.saveAppointment(i,null,n)}else{var s={id:e.data.id,start_datetime:e.start.format("YYYY-MM-DD HH:mm:ss"),end_datetime:e.end.format("YYYY-MM-DD HH:mm:ss"),id_users_provider:e.data.id_users_provider};e.data.end_datetime=s.end_datetime,n=function(){var n=function(){s.end_datetime=e.data.end_datetime=Date.parseExact(s.end_datetime,"yyyy-MM-dd HH:mm:ss").add({minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss");var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_unavailable",r={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(s)};$.post(n,r).done(function(){$("#notification").hide("blind")}),a()};Backend.displayNotification(EALang.unavailable_updated,[{label:EALang.undo,function:n}]),$("#footer").css("position","static"),r.fullCalendar("updateEvent",e)},BackendCalendarApi.saveUnavailable(s,n)}}function v(e,t,a){if(!1===GlobalVariables.user.privileges.appointments.edit){a(),Backend.displayNotification(EALang.no_privileges_edit_appointments);return}if($("#notification").is(":visible")&&$("#notification").hide("bind"),"0"===e.data.is_unavailable){var n,r=GeneralFunctions.clone(e.data);delete r.customer,delete r.provider,delete r.service,r.start_datetime=Date.parseExact(r.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:t.days(),hours:t.hours(),minutes:t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),r.end_datetime=Date.parseExact(r.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:t.days(),hours:t.hours(),minutes:t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=r.start_datetime,e.data.end_datetime=r.end_datetime,n=function(){var n=function(){r.start_datetime=Date.parseExact(r.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-t.days(),hours:-t.hours(),minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),r.end_datetime=Date.parseExact(r.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-t.days(),hours:-t.hours(),minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=r.start_datetime,e.data.end_datetime=r.end_datetime;var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_appointment",i={csrfToken:GlobalVariables.csrfToken,appointment_data:JSON.stringify(r)};$.post(n,i).done(function(){$("#notification").hide("blind")}),a()};Backend.displayNotification(EALang.appointment_updated,[{label:EALang.undo,function:n}]),$("#footer").css("position","static")},BackendCalendarApi.saveAppointment(r,null,n)}else{var i={id:e.data.id,start_datetime:e.start.format("YYYY-MM-DD HH:mm:ss"),end_datetime:e.end.format("YYYY-MM-DD HH:mm:ss"),id_users_provider:e.data.id_users_provider};n=function(){var n=function(){i.start_datetime=Date.parseExact(i.start_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-t.days(),minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),i.end_datetime=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss").add({days:-t.days(),minutes:-t.minutes()}).toString("yyyy-MM-dd HH:mm:ss"),e.data.start_datetime=i.start_datetime,e.data.end_datetime=i.end_datetime;var n=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_save_unavailable",r={csrfToken:GlobalVariables.csrfToken,unavailable:JSON.stringify(i)};$.post(n,r).done(function(){$("#notification").hide("blind")}),a()};Backend.displayNotification(EALang.unavailable_updated,[{label:EALang.undo,function:n}]),$("#footer").css("position","static")},BackendCalendarApi.saveUnavailable(i,n)}}function y(){var e=window.innerHeight-$("#header").outerHeight()-$("#footer").outerHeight()-$("#calendar-toolbar").outerHeight()-$(".calendar-header").outerHeight()-50;e<500&&(e=500);var t=$(".date-column"),a=$(".calendar-view > div");a.css("min-width","1000%");var n=0;t.each(function(e,t){n+=$(t).outerWidth()}),a.css("min-width",n+200);var r=t.outerHeight();$(".calendar-view .not-working").outerHeight((r>e?r:e)-70)}function b(e,t){var a=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_get_calendar_events",n={csrfToken:GlobalVariables.csrfToken,startDate:e.toString("yyyy-MM-dd"),endDate:t.toString("yyyy-MM-dd")};return $.ajax({url:a,data:n,method:"POST",beforeSend:function(){},complete:function(){}})}e.initialize=function(){!function e(){$("#calendar-filter").find("select").empty().append(new Option("1 "+EALang.day,1)).append(new Option("3 "+EALang.days,3));var n,i=$("<div/>",{class:"calendar-header"}).appendTo("#calendar");switch($("<button/>",{class:"btn btn-xs btn-outline-secondary previous mr-2",html:[$("<span/>",{class:"fas fa-chevron-left"})]}).appendTo(i),$("<input/>",{type:"text",class:"form-control d-inline-block select-date mr-2",value:GeneralFunctions.formatDate(new Date,GlobalVariables.dateFormat,!1)}).appendTo(i),$("<button/>",{class:"btn btn-xs btn-outline-secondary next",html:[$("<span/>",{class:"fas fa-chevron-right"})]}).appendTo(i),GlobalVariables.dateFormat){case"DMY":n="dd/mm/yy";break;case"MDY":n="mm/dd/yy";break;case"YMD":n="yy/mm/dd";break;default:throw Error("Invalid date format setting provided: "+GlobalVariables.dateFormat)}i.find(".select-date").datepicker({defaultDate:new Date,dateFormat:n,onSelect:function(e,t){var a=new Date(t.currentYear,t.currentMonth,t.currentDay),n=new Date(a.getTime()).add({days:parseInt($("#select-filter-item").val())-1});r(a,n)}});var s=GlobalVariables.availableProviders.filter(function(e){return GlobalVariables.user.role_slug===Backend.DB_SLUG_ADMIN||GlobalVariables.user.role_slug===Backend.DB_SLUG_SECRETARY&&-1!==GlobalVariables.secretaryProviders.indexOf(e.id)||GlobalVariables.user.role_slug===Backend.DB_SLUG_PROVIDER&&Number(e.id)===Number(GlobalVariables.user.id)});$("<label/>",{text:EALang.provider}).appendTo(i),t=$("<select/>",{id:"filter-provider",multiple:"multiple",on:{change:function(){var e=new Date($(".calendar-view .date-column:first").data("date")),t=new Date(e.getTime()).add({days:parseInt($("#select-date").val())-1});r(e,t)}}}).appendTo(i),GlobalVariables.user.role_slug!==Backend.DB_SLUG_PROVIDER?s.forEach(function(e){t.append(new Option(e.first_name+" "+e.last_name,e.id))}):s.forEach(function(e){Number(e.id)===Number(GlobalVariables.user.id)&&t.append(new Option(e.first_name+" "+e.last_name,e.id))}),t.select2();var d=GlobalVariables.availableServices.filter(function(e){var t=s.find(function(t){return -1!==t.services.indexOf(e.id)});return GlobalVariables.user.role_slug===Backend.DB_SLUG_ADMIN||t});$("<label/>",{text:EALang.service}).appendTo(i),a=$("<select/>",{id:"filter-service",multiple:"multiple",on:{change:function(){var e=new Date($(".calendar-view .date-column:first").data("date")),t=new Date(e.getTime()).add({days:parseInt($("#select-date").val())-1});r(e,t)}}}).appendTo(i),d.forEach(function(e){a.append(new Option(e.name,e.id))}),a.select2()}();var e,i,s=moment().toDate(),d=moment().add(Number($("#select-filter-item").val())-1,"days").toDate();r(s,d),$("#insert-working-plan-exception").hide(),e=$("#calendar-toolbar"),(i=$("#calendar")).on("click",".calendar-header .btn.previous",function(){var e=$("#select-filter-item").val(),t=$(".select-date").datepicker("getDate"),a=moment(t).subtract(1,"days"),n=a.clone().add(e-1,"days");$(".select-date").datepicker("setDate",a.toDate()),r(a.toDate(),n.toDate())}),i.on("click",".calendar-header .btn.next",function(){var e=$("#select-filter-item").val(),t=$(".select-date").datepicker("getDate"),a=moment(t).add(1,"days"),n=a.clone().add(e-1,"days");$(".select-date").datepicker("setDate",a.toDate()),r(a.toDate(),n.toDate())}),e.on("change","#select-filter-item",function(){var e=$("#select-filter-item").val(),t=$(".select-date").datepicker("getDate"),a=moment(t),n=a.clone().add(e-1,"days");r(a.toDate(),n.toDate())}),e.on("click","#reload-appointments",function(){$(".calendar-view .event").remove();var e=$("#select-filter-item").val(),t=$(".select-date").datepicker("getDate"),a=moment(t),n=a.toDate(),r=a.clone().add(e-1,"days").toDate();b(n,r).done(function(e){for(var t=n;t<=r;)$(".calendar-view .date-column").each(function(a,n){var r=$(n),i=new Date(r.data("date"));if(t.getTime()!==i.getTime())return!0;r.find(".date-column-title").text(GeneralFunctions.formatDate(i,GlobalVariables.dateFormat)),r.find(".provider-column").each(function(t,a){var n=$(a),r=n.data("provider");n.find(".calendar-wrapper").fullCalendar("removeEvents"),o(n.find(".calendar-wrapper"),n.data("provider")),l(n,e.appointments),c(n,e.unavailability_events);var s=JSON.parse(r.settings.working_plan),d=i.toString("dddd").toLowerCase();s[d]&&p(n,s[d].breaks)})}),t.add({days:1});Backend.placeFooterToBottom()})}),$(window).on("resize",function(){y()}),i.on("click",".close-popover",function(){$(this).parents(".popover").popover("dispose")}),i.on("click",".edit-popover",function(){if($(this).parents(".popover").popover("dispose"),n.data.workingPlanException){var e,t=n.data.date,a=n.data.workingPlanException,r=n.data.provider;WorkingPlanExceptionsModal.edit(t,a).done(function(e,t){var a=function(){Backend.displayNotification(EALang.working_plan_exception_saved);var a=JSON.parse(r.settings.working_plan_exceptions)||{};for(var n in a[e]=t,GlobalVariables.availableProviders){var i=GlobalVariables.availableProviders[n];if(Number(i.id)===Number(r.id)){i.settings.working_plan_exceptions=JSON.stringify(a);break}}$("#select-filter-item").trigger("change")};BackendCalendarApi.saveWorkingPlanException(e,t,r.id,a,null)})}else if("0"===n.data.is_unavailable){var i=n.data;e=$("#manage-appointment"),BackendCalendarAppointmentsModal.resetAppointmentDialog(),e.find(".modal-header h3").text(EALang.edit_appointment_title),e.find("#appointment-id").val(i.id),e.find("#select-service").val(i.id_services).trigger("change"),e.find("#select-provider").val(i.id_users_provider);var s=Date.parseExact(i.start_datetime,"yyyy-MM-dd HH:mm:ss");e.find("#start-datetime").datetimepicker("setDate",s);var d=Date.parseExact(i.end_datetime,"yyyy-MM-dd HH:mm:ss");e.find("#end-datetime").datetimepicker("setDate",d);var o=i.customer;e.find("#customer-id").val(i.id_users_customer),e.find("#first-name").val(o.first_name),e.find("#last-name").val(o.last_name),e.find("#email").val(o.email),e.find("#phone-number").val(o.phone_number),e.find("#address").val(o.address),e.find("#city").val(o.city),e.find("#zip-code").val(o.zip_code),e.find("#appointment-location").val(i.location),e.find("#appointment-notes").val(i.notes),e.find("#customer-notes").val(o.notes),e.find('input[name="sex"]').prop("checked",!1),e.find("#sex-"+o.sex).prop("checked",!0),e.find("#birth-date").val(o.birth_date),e.find("#passport-number").val(o.passport_number),e.find("#passport-expiry-date").val(o.passport_expiry_date);let l=o.applicant_type,c="ID #";switch(e.find(".client-id-reference-number-container").addClass("d-none"),e.find(".visa-category-container").addClass("d-none"),e.find(".visa-type-container").addClass("d-none"),e.find(".canada-applicants-info").addClass("d-none"),e.find(".australia-applicants-info").addClass("d-none"),e.find(".new-zealand-applicants-info").addClass("d-none"),l){case"CANADA":c="IME/UCCI #",e.find(".canada-applicants-info").removeClass("d-none"),e.find(".client-id-reference-number-container").removeClass("d-none"),e.find(".visa-category-container").removeClass("d-none"),e.find(".visa-type-container").removeClass("d-none");break;case"AUSTRALIA":c="HAP ID",e.find(".australia-applicants-info").removeClass("d-none"),e.find(".client-id-reference-number-container").removeClass("d-none");break;case"NEW ZEALAND":c="NZER/NZHR",e.find(".new-zealand-applicants-info").removeClass("d-none"),e.find(".client-id-reference-number-container").removeClass("d-none"),e.find(".visa-category-container").removeClass("d-none"),e.find(".visa-type-container").removeClass("d-none");break;default:e.find(".client-id-reference-number-container").addClass("d-none"),e.find(".visa-category-container").addClass("d-none"),e.find(".visa-type-container").addClass("d-none")}e.find('label[for="client-id-reference-number"]').text(c),e.find("#applicant-type").val(l),e.find("#client-id-reference-number").val(o.client_id_reference_number),e.find("#visa-category").val(o.visa_category),e.find("#visa-type").val(o.visa_type),e.modal("show")}else{var p=n.data;p.start_datetime=n.start.format("YYYY-MM-DD HH:mm:ss");var s=Date.parseExact(p.start_datetime,"yyyy-MM-dd HH:mm:ss");p.end_datetime=n.end.format("YYYY-MM-DD HH:mm:ss");var d=Date.parseExact(p.end_datetime,"yyyy-MM-dd HH:mm:ss");e=$("#manage-unavailable"),BackendCalendarUnavailabilityEventsModal.resetUnavailableDialog(),e.find(".modal-header h3").text("Edit Unavailable Period"),e.find("#unavailable-start").datetimepicker("setDate",s),e.find("#unavailable-id").val(p.id),e.find("#unavailable-provider").val(p.id_users_provider),e.find("#unavailable-end").datetimepicker("setDate",d),e.find("#unavailable-notes").val(p.notes),e.modal("show")}}),i.on("click",".delete-popover",function(){if($(this).parents(".popover").popover("dispose"),n.data.workingPlanException)e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_working_plan_exception",t={csrfToken:GlobalVariables.csrfToken,working_plan_exception:n.start.format("YYYY-MM-DD"),provider_id:n.data.provider.id},$.post(e,t).done(function(){$("#message-box").dialog("close");var e=JSON.parse(n.data.provider.settings.working_plan_exceptions);delete e[n.start.format("YYYY-MM-DD")],n.data.provider.settings.working_plan_exceptions=JSON.stringify(e),$("#select-filter-item").trigger("change")});else if("0"===n.data.is_unavailable){var e,t,a=[{text:EALang.cancel,click:function(){$("#message-box").dialog("close")}},{text:"OK",click:function(){e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_appointment",t={csrfToken:GlobalVariables.csrfToken,appointment_id:n.data.id,delete_reason:$("#delete-reason").val()},$.post(e,t).done(function(){$("#message-box").dialog("close"),$("#select-filter-item").trigger("change")})}}];GeneralFunctions.displayMessageBox(EALang.delete_appointment_title,EALang.write_appointment_removal_reason,a),$("<textarea/>",{class:"form-control w-100",id:"delete-reason",rows:"3"}).appendTo("#message-box")}else e=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_delete_unavailable",t={csrfToken:GlobalVariables.csrfToken,unavailable_id:n.data.id},$.post(e,t).done(function(){$("#message-box").dialog("close"),$("#select-filter-item").trigger("change")})}),$("#enable-sync, #google-sync").hide()}}(window.BackendCalendarTableView);