window.BackendCalendarAppointmentsModal=window.BackendCalendarAppointmentsModal||{},function(e){"use strict";e.resetAppointmentDialog=function(){var e,t=$("#manage-appointment");t.find("input, textarea").val(""),t.find(".modal-message").fadeOut(),t.find("#select-service").val(t.find("#select-service").eq(0).attr("value")),t.find("#select-provider").empty(),GlobalVariables.availableProviders.forEach(function(e,a){var n=!1,i=t.find("#select-service").val(),n=e.services.filter(function(e){return Number(e)===Number(i)}).length>0;n&&t.find("#select-provider").append(new Option(e.first_name+" "+e.last_name,e.id))}),$("#existing-customers-list").slideUp("slow"),$("#filter-existing-customers").fadeOut("slow"),$("#select-customer span").text(EALang.select);var a=t.find("#select-service").val(),n=GlobalVariables.availableServices.forEach(function(e){return Number(e.id)===Number(a)}),i=n?n.duration:0,s=new Date,r=new Date().addMinutes(i);switch(GlobalVariables.dateFormat){case"DMY":e="dd/mm/yy";break;case"MDY":e="mm/dd/yy";break;case"YMD":e="yy/mm/dd";break;default:throw Error("Invalid GlobalVariables.dateFormat value.")}var d=GlobalVariables.firstWeekday,o=GeneralFunctions.getWeekDayId(d);t.find("#start-datetime").datetimepicker({dateFormat:e,timeFormat:"regular"===GlobalVariables.timeFormat?"h:mm TT":"HH:mm",dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:o,onClose:function(){var e=$("#select-service").val(),t=GlobalVariables.availableServices.find(function(t){return Number(t.id)===Number(e)}),a=$("#start-datetime").datetimepicker("getDate");$("#end-datetime").datetimepicker("setDate",new Date(a.getTime()+6e4*t.duration))}}),t.find("#start-datetime").datetimepicker("setDate",s),t.find("#end-datetime").datetimepicker({dateFormat:e,timeFormat:"regular"===GlobalVariables.timeFormat?"h:mm TT":"HH:mm",dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,timeOnlyTitle:EALang.select_time,timeText:EALang.time,hourText:EALang.hour,minuteText:EALang.minutes,firstDay:o}),t.find("#end-datetime").datetimepicker("setDate",r)},e.initialize=function(){var e;$("#manage-appointment #save-appointment").on("click",function(){if(function e(){var t=$("#manage-appointment");t.find(".has-error").removeClass("has-error"),t.find(".modal-message").addClass("d-none");try{var a=!1;if(t.find(".required").each(function(e,t){(""===$(t).val()||null===$(t).val())&&($(t).closest(".form-group").addClass("has-error"),a=!0)}),a)throw Error(EALang.fields_are_required);if(!GeneralFunctions.validateEmail(t.find("#email").val()))throw t.find("#email").closest(".form-group").addClass("has-error"),Error(EALang.invalid_email);var n=$("#start-datetime").datetimepicker("getDate"),i=$("#end-datetime").datetimepicker("getDate");if(n>i)throw t.find("#start-datetime, #end-datetime").closest(".form-group").addClass("has-error"),Error(EALang.start_date_before_end_error);return!0}catch(s){return t.find(".modal-message").addClass("alert-danger").text(s.message).removeClass("d-none"),!1}}()){var e=$("#manage-appointment"),t=e.find("#start-datetime").datetimepicker("getDate").toString("yyyy-MM-dd HH:mm:ss"),a=e.find("#end-datetime").datetimepicker("getDate").toString("yyyy-MM-dd HH:mm:ss"),n={id_services:e.find("#select-service").val(),id_users_provider:e.find("#select-provider").val(),start_datetime:t,end_datetime:a,location:e.find("#appointment-location").val(),notes:e.find("#appointment-notes").val(),is_unavailable:!1};""!==e.find("#appointment-id").val()&&(n.id=e.find("#appointment-id").val());var i={first_name:e.find("#first-name").val(),last_name:e.find("#last-name").val(),email:e.find("#email").val(),phone_number:e.find("#phone-number").val(),address:e.find("#address").val(),city:e.find("#city").val(),zip_code:e.find("#zip-code").val(),notes:e.find("#customer-notes").val(),sex:$('input[name="sex"]:checked').val(),birth_date:$("#birth-date").val(),passport_number:$("#passport-number").val(),passport_expiry_date:$("#passport-expiry-date").val(),applicant_type:$("#applicant-type").val(),client_id_reference_number:$("#client-id-reference-number").val(),visa_category:$("#visa-category").val(),visa_type:$("#visa-type").val()};""!==e.find("#customer-id").val()&&(i.id=e.find("#customer-id").val(),n.id_users_customer=i.id);var s=function(t){Backend.displayNotification(EALang.appointment_saved),e.find(".alert").addClass("d-none"),e.modal("hide"),$("#select-filter-item").trigger("change")},r=function(){e.find(".modal-message").text(EALang.service_communication_error),e.find(".modal-message").addClass("alert-danger").removeClass("d-none"),e.find(".modal-body").scrollTop(0)};BackendCalendarApi.saveAppointment(n,i,s,r)}}),$("#insert-appointment").on("click",function(){$(".popover").remove(),BackendCalendarAppointmentsModal.resetAppointmentDialog();var e=$("#manage-appointment");if("provider"===$("#select-filter-item option:selected").attr("type")){var t=$("#select-filter-item").val(),a=GlobalVariables.availableProviders.filter(function(e){return Number(e.id)===Number(t)});a.length&&(e.find("#select-service").val(a[0].services[0]).trigger("change"),e.find("#select-provider").val(t))}else"service"===$("#select-filter-item option:selected").attr("type")?e.find('#select-service option[value="'+$("#select-filter-item").val()+'"]').prop("selected",!0):e.find("#select-service option:first").prop("selected",!0).trigger("change");var n=e.find("#select-service").val(),i=GlobalVariables.availableServices.find(function(e){return Number(e.id)===Number(n)}),s=i?i.duration:60,r=new Date,d=parseInt(r.toString("mm"));d>0&&d<15?r.set({minute:15}):d>15&&d<30?r.set({minute:30}):d>30&&d<45?r.set({minute:45}):r.addHours(1).set({minute:0}),e.find("#start-datetime").val(GeneralFunctions.formatDate(r,GlobalVariables.dateFormat,!0)),e.find("#end-datetime").val(GeneralFunctions.formatDate(r.addMinutes(s),GlobalVariables.dateFormat,!0)),e.find(".modal-header h3").text(EALang.new_appointment_title),e.modal("show")}),$("#select-customer").on("click",function(){var e=$("#existing-customers-list");e.is(":visible")?(e.slideUp("slow"),$("#filter-existing-customers").fadeOut("slow"),$(this).find("span").text(EALang.select)):($(this).find("span").text(EALang.hide),e.empty(),e.slideDown("slow"),$("#filter-existing-customers").fadeIn("slow"),$("#filter-existing-customers").val(""),GlobalVariables.customers.forEach(function(t){$("<div/>",{"data-id":t.id,text:t.first_name+" "+t.last_name}).appendTo(e)}))}),$("#manage-appointment").on("click","#existing-customers-list div",function(){var e=$(this).attr("data-id"),t=GlobalVariables.customers.find(function(t){return Number(t.id)===Number(e)});if(t){$("#customer-id").val(t.id),$("#first-name").val(t.first_name),$("#last-name").val(t.last_name),$("#email").val(t.email),$("#phone-number").val(t.phone_number),$("#address").val(t.address),$("#city").val(t.city),$("#zip-code").val(t.zip_code),$("#customer-notes").val(t.notes),$('input[name="sex"]').prop("checked",!1),$("#sex-"+t.sex).prop("checked",!0),$("#birth-date").val(t.birth_date),$("#passport-number").val(t.passport_number),$("#passport-expiry-date").val(t.passport_expiry_date);let a=t.applicant_type,n="ID #";switch($(".client-id-reference-number-container").addClass("d-none"),$(".visa-category-container").addClass("d-none"),$(".visa-type-container").addClass("d-none"),$(".canada-applicants-info").addClass("d-none"),$(".australia-applicants-info").addClass("d-none"),$(".new-zealand-applicants-info").addClass("d-none"),a){case"CANADA":n="IME/UCCI #",$(".canada-applicants-info").removeClass("d-none"),$(".client-id-reference-number-container").removeClass("d-none"),$(".visa-category-container").removeClass("d-none"),$(".visa-type-container").removeClass("d-none");break;case"AUSTRALIA":n="HAP ID",$(".australia-applicants-info").removeClass("d-none"),$(".client-id-reference-number-container").removeClass("d-none");break;case"NEW ZEALAND":n="NZER/NZHR",$(".new-zealand-applicants-info").removeClass("d-none"),$(".client-id-reference-number-container").removeClass("d-none"),$(".visa-category-container").removeClass("d-none"),$(".visa-type-container").removeClass("d-none");break;default:$(".client-id-reference-number-container").addClass("d-none"),$(".visa-category-container").addClass("d-none"),$(".visa-type-container").addClass("d-none")}$('label[for="client-id-reference-number"]').text(n),$("#applicant-type").val(a),$("#client-id-reference-number").val(t.client_id_reference_number),$("#visa-category").val(t.visa_category),$("#visa-type").val(t.visa_type)}$("#select-customer").trigger("click")}),e=null,$("#filter-existing-customers").on("keyup",function(){e&&clearTimeout(e);var t=$(this).val().toLowerCase();e=setTimeout(function(){var e=$("#existing-customers-list"),a=GlobalVariables.baseUrl+"/index.php/backend_api/ajax_filter_customers",n={csrfToken:GlobalVariables.csrfToken,key:t};$("#loading").css("visibility","hidden"),$.post(a,n).done(function(t){e.empty(),t.forEach(function(t){$("<div/>",{"data-id":t.id,text:t.first_name+" "+t.last_name}).appendTo(e),GlobalVariables.customers.filter(function(e){return Number(e.id)===Number(t.id)}).length||GlobalVariables.customers.push(t)})}).fail(function(a,n,i){e.empty(),GlobalVariables.customers.forEach(function(a,n){(-1!==a.first_name.toLowerCase().indexOf(t)||-1!==a.last_name.toLowerCase().indexOf(t)||-1!==a.email.toLowerCase().indexOf(t)||-1!==a.phone_number.toLowerCase().indexOf(t)||-1!==a.address.toLowerCase().indexOf(t)||-1!==a.city.toLowerCase().indexOf(t)||-1!==a.zip_code.toLowerCase().indexOf(t)||-1!==a.notes.toLowerCase().indexOf(t))&&$("<div/>",{"data-id":a.id,text:a.first_name+" "+a.last_name}).appendTo(e)})}).always(function(){$("#loading").css("visibility","")})},1e3)}),$("#select-service").on("change",function(){var e=$("#select-service").val();$("#select-provider").empty();var t=GlobalVariables.availableServices.find(function(t){return Number(t.id)===Number(e)}),a=t?t.duration:60,n=$("#start-datetime").datetimepicker("getDate");$("#end-datetime").datetimepicker("setDate",new Date(n.getTime()+6e4*a)),GlobalVariables.availableProviders.forEach(function(t){t.services.forEach(function(a){(GlobalVariables.user.role_slug!==Backend.DB_SLUG_PROVIDER||Number(t.id)===GlobalVariables.user.id)&&(GlobalVariables.user.role_slug!==Backend.DB_SLUG_SECRETARY||-1!==GlobalVariables.secretaryProviders.indexOf(t.id))&&Number(a)===Number(e)&&$("#select-provider").append(new Option(t.first_name+" "+t.last_name,t.id))})})}),$("#select-provider").on("change",function(){var e,t;e=$("#select-provider").val(),(t=GlobalVariables.availableProviders.find(function(t){return Number(t.id)===Number(e)}))&&t.timezone&&$(".provider-timezone").text(GlobalVariables.timezones[t.timezone])}),$("#new-customer").on("click",function(){$("#manage-appointment").find("#customer-id, #first-name, #last-name, #email, #phone-number, #address, #city, #zip-code, #customer-notes").val(""),$('input[name="sex"]').prop("checked",!1),$("#birth-date").val(""),$("#passport-number").val(""),$("#passport-expiry-date").val(""),$(".client-id-reference-number-container").addClass("d-none"),$(".visa-category-container").addClass("d-none"),$(".visa-type-container").addClass("d-none"),$(".canada-applicants-info").addClass("d-none"),$(".australia-applicants-info").addClass("d-none"),$(".new-zealand-applicants-info").addClass("d-none"),$("#applicant-type").val(""),$("#client-id-reference-number").val(""),$("#visa-category").val(""),$("#visa-type").val("")})}}(window.BackendCalendarAppointmentsModal);